<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Concept Diagram Generator (PDF OCR)</title>

<script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html-to-image@1.11.11/dist/html-to-image.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@3.9.179/build/pdf.min.js"></script>

<script>
mermaid.initialize({ startOnLoad: false, theme: "base", themeVariables: { fontFamily: "Arial" } });
</script>

<style>
body { font-family: Arial, sans-serif; background: #f8fafc; margin: 0; }
header { background: #0f172a; color: white; padding: 20px; }
section { padding: 16px; }
#diagram-container { border: 1px solid #cbd5e1; background: white; overflow: hidden; height: 70vh; cursor: grab; }
#viewport { transform-origin: 0 0; will-change: transform; }
#diagram-container.dragging { cursor: grabbing; }
#diagram-container.dragging * { user-select: none; }

button { margin-right: 8px; }
</style>
</head>

<body>
<header>
  <h1>Concept Diagram Generator</h1>
  <p>Upload PDFs to extract text via OCR ‚Üí Mermaid diagram</p>
</header>

<section>
  <input type="file" id="fileInput" multiple accept="application/pdf" />
  <button id="runOCR" disabled>Run OCR & Generate Diagram</button>
</section>

<section id="diagram-title" style="padding:16px; font-weight:bold; font-size:18px;"></section>

<section id="diagram-container">
  <div id="viewport">
    <div id="diagram"></div>
    <pre id="mermaidCode" style="display:none; white-space: pre-wrap;"></pre>
  </div>
</section>

<section>
  <h3>OCR Progress</h3>
  <div id="ocrProgress"></div>
</section>

<section>
  <h3>Server Logs</h3>
  <pre id="serverLogs" style="background:#111;color:#eee;padding:10px;overflow:auto;max-height:300px;white-space:pre-wrap;"></pre>
</section>

<script>
const fileInput = document.getElementById("fileInput");
const runBtn = document.getElementById("runOCR");
let selectedFiles = [];

fileInput.addEventListener("change", () => {
  selectedFiles = Array.from(fileInput.files);
  runBtn.disabled = selectedFiles.length === 0;
});

// PDF ‚Üí image ‚Üí OCR
async function pdfToText(file) {
  const arrayBuffer = await file.arrayBuffer();
  const pdf = await pdfjsLib.getDocument({data: arrayBuffer}).promise;
  let fullText = "";

  for (let i = 1; i <= pdf.numPages; i++) {
    const page = await pdf.getPage(i);
    const viewport = page.getViewport({ scale: 2 });
    const canvas = document.createElement("canvas");
    canvas.width = viewport.width;
    canvas.height = viewport.height;
    const ctx = canvas.getContext("2d");
    await page.render({ canvasContext: ctx, viewport }).promise;

    updateOCRProgress(file.name, `Page ${i} rendering`);

    const { data } = await Tesseract.recognize(canvas, "eng", {
      logger: m => {
        if (m.status === "recognizing text") {
          const pct = Math.round(m.progress * 100);
          updateOCRProgress(file.name, `Page ${i} OCR`, pct);
        }
      }
    });

    fullText += data.text + "\n";
  }

  return fullText.trim();
}

function updateOCRProgress(fileName, status, pct=null) {
  const container = document.getElementById("ocrProgress");
  let row = document.getElementById(`ocr-${fileName}`);
  if (!row) {
    row = document.createElement("div");
    row.id = `ocr-${fileName}`;
    row.style.marginBottom = "6px";
    container.appendChild(row);
  }
  row.textContent = pct !== null ? `üìÑ ${fileName}: ${status} (${pct}%)` : `üìÑ ${fileName}: ${status}`;
}

runBtn.addEventListener("click", async () => {
  if (!selectedFiles.length) return alert("Select PDFs first");

  const formData = new FormData();
  document.getElementById("diagram-title").textContent = "Title: " + selectedFiles.map(f=>f.name).join(", ");

  for (const file of selectedFiles) {
    const text = await pdfToText(file);
    if (!text.trim()) { alert(`OCR failed for ${file.name}`); return; }
    formData.append("files", new File([new Blob([text], {type:"text/plain"})], file.name+".txt"));
  }

  logToPage("üì§ Sending OCR text to /api/generate");
  try {
    const res = await fetch("/api/generate", { method:"POST", body: formData });
    logToPage(`üì• Response status: ${res.status}`);
    const mermaidCode = await res.text();
    logToPage("üß† Mermaid code received:\n"+mermaidCode);
    renderDiagram(mermaidCode);
    logToPage("‚úÖ Done");
  } catch(err) {
    console.error(err);
    logToPage("‚ùå Request failed", "error");
  }
});

async function renderDiagram(code) {
  if (!code.includes("graph")) { alert("Server error:\n"+code); return; }
  const diagram = document.getElementById("diagram");
  diagram.innerHTML = `<div class="mermaid">\n${code}\n</div>`;
  document.getElementById("mermaidCode").textContent = code;
  await mermaid.run();
}

function logToPage(msg,type="info") {
  const logsDiv = document.getElementById("serverLogs");
  const time = new Date().toLocaleTimeString();
  const prefix = type==="error"?"[ERROR] ": type==="warn"?"[WARN] ":"[INFO] ";
  logsDiv.textContent += `${time} ${prefix}${msg}\n`;
  logsDiv.scrollTop = logsDiv.scrollHeight;
}
</script>
</body>
</html>
