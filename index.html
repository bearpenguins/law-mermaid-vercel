<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Concept Diagram Generator</title>

<!-- Libraries -->
<script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html-to-image@1.11.11/dist/html-to-image.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

<script>
mermaid.initialize({ startOnLoad: false, theme: "base", themeVariables: { fontFamily: "Arial" } });
</script>

<style>
body { font-family: Arial, sans-serif; background: #f8fafc; margin: 0; }
header { background: #0f172a; color: white; padding: 20px; }
section { padding: 16px; }
#diagram-container { border: 1px solid #cbd5e1; background: white; overflow: hidden; height: 70vh; cursor: grab; }
#viewport { transform-origin: 0 0; will-change: transform; }
#diagram-container.dragging { cursor: grabbing; }
#diagram-container.dragging * { user-select: none; }

button { margin-right: 8px; }
.legend { padding: 6px 10px; border-radius: 6px; font-size: 14px; border: 1px solid; cursor: pointer; user-select: none; }
.legend.case { background:#fef3c7; border-color:#92400e; }
.legend.person { background:#e0f2fe; border-color:#0369a1; }
.legend.organisation { background:#dcfce7; border-color:#166534; }
.legend.legal_issue { background:#fee2e2; border-color:#991b1b; }
.legend.event { background:#ede9fe; border-color:#5b21b6; }
.legend.document { background:#f1f5f9; border-color:#334155; }
.legend.location { background:#fff7ed; border-color:#9a3412; }
.node.dim { opacity: 0.15; }
.legend.active { outline: 2px solid #0f172a; }
</style>
</head>

<body>
<header>
  <h1>Concept Diagram Generator</h1>
  <p>Attach PDF or image files for OCR ‚Üí text ‚Üí Mermaid diagram</p>
</header>

<section>
  <input type="file" id="fileInput" multiple accept="image/*,.pdf" />
  <button id="runOCR" disabled>Run OCR & Generate Diagram</button>
</section>

<section id="diagram-title" style="padding:16px; font-weight:bold; font-size:18px;"></section>

<section id="diagram-container">
  <div id="viewport">
    <div id="diagram"></div>
    <pre id="mermaidCode" style="display:none; white-space: pre-wrap;"></pre>
  </div>
</section>

<section>
  <h3>OCR Progress</h3>
  <div id="ocrProgress"></div>
</section>

<section>
  <h3>Server Logs</h3>
  <pre id="serverLogs" style="background:#111;color:#eee;padding:10px;overflow:auto;max-height:300px;white-space:pre-wrap;"></pre>
</section>

<script>
const fileInput = document.getElementById("fileInput");
const runBtn = document.getElementById("runOCR");
let selectedFiles = [];

fileInput.addEventListener("change", () => {
  selectedFiles = Array.from(fileInput.files);
  runBtn.disabled = selectedFiles.length === 0;
});

// Initialize a single worker
let tesseractWorker = null;

async function ocrFile(file) {
  if (!tesseractWorker) {
    tesseractWorker = await Tesseract.createWorker({
      logger: m => {
        if (m.status === "recognizing text") {
          updateOCRProgress(m.jobId, m.status, Math.round(m.progress*100));
        }
      },
      workerPath: "https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/worker.min.js",
      corePath: "https://cdn.jsdelivr.net/npm/tesseract.js-core@5.1.0/",
      langPath: "https://tessdata.projectnaptha.com/4.0.0"
    });
    await tesseractWorker.load();
    await tesseractWorker.loadLanguage("eng");
    await tesseractWorker.initialize("eng");
  }

  const { data } = await tesseractWorker.recognize(file);
  return data.text || "";
}

function updateOCRProgress(fileName, status, pct = null) {
  const container = document.getElementById("ocrProgress");
  let row = document.getElementById(`ocr-${fileName}`);
  if (!row) {
    row = document.createElement("div");
    row.id = `ocr-${fileName}`;
    row.style.marginBottom = "6px";
    container.appendChild(row);
  }
  row.textContent = pct !== null ? `üìÑ ${fileName}: ${status} (${pct}%)` : `üìÑ ${fileName}: ${status}`;
}

async function generateDiagram() {
  if (!selectedFiles.length) return alert("Select files first");

  const formData = new FormData();
  document.getElementById("diagram-title").textContent = "Title: " + selectedFiles.map(f=>f.name).join(", ");

  for (const file of selectedFiles) {
    updateOCRProgress(file.name, "Starting OCR...");
    const text = await ocrFile(file);
    updateOCRProgress(file.name, "Completed", 100);

    if (!text.trim()) { alert(`OCR failed for ${file.name}`); return; }

    formData.append("files", new File([new Blob([text], {type:"text/plain"})], file.name+".txt"));
  }

  logToPage("üì§ Sending files to /api/generate");

  try {
    const res = await fetch("/api/generate", { method:"POST", body: formData });
    logToPage(`üì• Response status: ${res.status}`);
    const mermaidCode = await res.text();
    logToPage("üß† Mermaid code received:\n" + mermaidCode);
    renderDiagram(mermaidCode);
    logToPage("‚úÖ Done");
  } catch(err) {
    console.error(err);
    logToPage("‚ùå Request failed", "error");
  }
}

async function renderDiagram(code) {
  if (!code.includes("graph")) { alert("Server error:\n"+code); return; }
  const diagram = document.getElementById("diagram");
  diagram.innerHTML = `<div class="mermaid">\n${code}\n</div>`;
  document.getElementById("mermaidCode").textContent = code;
  await mermaid.run();
  resetZoom();
  enableLegendFiltering();
}

function logToPage(msg,type="info") {
  const logsDiv = document.getElementById("serverLogs");
  const time = new Date().toLocaleTimeString();
  const prefix = type==="error"?"[ERROR] ": type==="warn"?"[WARN] ":"[INFO] ";
  logsDiv.textContent += `${time} ${prefix}${msg}\n`;
  logsDiv.scrollTop = logsDiv.scrollHeight;
}

/* --- Legend filtering, zoom, pan --- */
let scale=1, tx=0, ty=0, dragging=false, startX,startY;
const viewportEl = document.getElementById("viewport");
const containerEl = document.getElementById("diagram-container");

containerEl.addEventListener("mousedown", e=>{ dragging=true; startX=e.clientX-tx; startY=e.clientY-ty; containerEl.classList.add("dragging"); });
window.addEventListener("mousemove", e=>{ if(!dragging) return; tx=e.clientX-startX; ty=e.clientY-startY; viewportEl.style.transform=`translate(${tx}px,${ty}px) scale(${scale})`; });
window.addEventListener("mouseup", ()=>{ dragging=false; containerEl.classList.remove("dragging"); });

function zoom(f){ scale*=f; scale=Math.min(Math.max(scale,0.2),5); viewportEl.style.transform=`translate(${tx}px,${ty}px) scale(${scale})`; }
function resetZoom(){ scale=1; tx=0; ty=0; viewportEl.style.transform=`translate(0,0) scale(1)`; }
function enableLegendFiltering(){ /* same as previous */ }
</script>
</body>
</html>
